-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

"""
ENSURE THIS IS AN OFFICIAL CODE
Use our PGP public key (you should never update this once saved)
http://l3n6v6dm63frml22tlmzacnasvp7co7wylu4hhcs34ukxe7q56yb4tyd.onion/static/public

step 1:
review code

step 2:
install python 3.x

step 3:
pip3 install requests pillow colorama cryptography

step 4:
install / run tor as a proxy

step 5:
run client.py

Windows tor proxy:
CLEARNET!!: https://stackoverflow.com/questions/45972637/getting-tor-controlport-to-work/46303954#46303954

Ubuntu tor proxy:
1. sudo apt install tor
2. service tor start
3. service tor status
"""


# Importing needed modules
import tkinter  # used for basic gui
from tkinter import filedialog  # used to ask for file
from sys import exit as sysExit  # used to kill script
import requests as unsafeRequests  # used to make HTTP calls via tor proxy
from requests.exceptions import ConnectionError  # raised when tor proxy doesn't work
from io import BytesIO  # used to pass bytes to Image.open
from PIL import Image  # used to render captcha using default image viewer
from colorama import init, Fore  # used for terminal colours
from cryptography.fernet import Fernet  # local fernet crypto
from os.path import basename  # used to get the base name of the file being uploaded

init()

ROOT = tkinter.Tk()
ROOT.withdraw()

CURRENT_VERSION = "0.0.3"

DEFAULT_HOST = "127.0.0.1"
DEFAULT_PORT = "9050"

SITE = "http://l3n6v6dm63frml22tlmzacnasvp7co7wylu4hhcs34ukxe7q56yb4tyd.onion/{page}"

print("\n" * 350)

print(
    Fore.LIGHTBLUE_EX,
    r"""
             _        __ _ _
            (_)      / _(_) |
  _ __  _ __ ___   _| |_ _| | ___  ___
 | '_ \| '__| \ \ / /  _| | |/ _ \/ __|
 | |_) | |  | |\ V /| | | | |  __/\__ \
 | .__/|_|  |_| \_/ |_| |_|_|\___||___/
 | |
 |_|
    """,
    Fore.RESET
)
print(SITE.format(page=""), "\n")
print(f"truly private file sharing\nversion: {Fore.GREEN}{CURRENT_VERSION}{Fore.RESET}\n\n")


host = input(f"Tor host [{DEFAULT_HOST}]: ")
if not host:
    host = DEFAULT_HOST

port = input(f"Tor port [{DEFAULT_PORT}]: ")
if not port:
    port = DEFAULT_PORT


ADDRESS = f"socks5h://{host}:{port}"

REQUESTS = unsafeRequests.sessions.Session()
REQUESTS.proxies = {
    "http": ADDRESS,
    "https": ADDRESS
}
REQUESTS.headers["User-Agent"] = "Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0"


def captcha() -> str:
    try:
        resp = REQUESTS.get(SITE.format(page="generate-captcha"))
    except ConnectionError:
        sysExit(Fore.RED + "Unable to connect to tor proxy with given details. Is it running?")

    if resp.status_code == 200:
        image = Image.open(BytesIO(resp.content))
    else:
        sysExit(Fore.RED + f"error, status code {resp.status_code}")

    image.show()
    code = input("captcha code (view opened image, type 'hate' if its not readable): ")
    image.close()

    return code


def upload_intent(file_path: str = None, custom_key: bytes = None):
    print("\n" * 350)
    if file_path:
        print(Fore.RED + "Invalid captcha, try again", Fore.RESET)

    if not custom_key:
        invalid_key = True
        while invalid_key:
            print(Fore.YELLOW + "A URL-safe base64-encoded 32-byte key.", Fore.RESET)
            custom_key_input = input("custom key [generate for me]: ")
            if not custom_key_input:
                custom_key = Fernet.generate_key()
            else:
                custom_key = custom_key_input.encode()

            try:
                fer = Fernet(custom_key)
            except Exception:
                print(Fore.RED + "Invalid key!")
                invalid_key = True
            else:
                invalid_key = False
    else:
        fer = Fernet(custom_key)

    print("please wait... downloading captcha")
    given_code = captcha()
    while given_code.lower() == "hate":
        given_code = captcha()

    if not file_path:
        print("please select a file to upload (max 900 MB)")
        file_path = filedialog.askopenfilename()
        if not file_path:
            sysExit(Fore.YELLOW + "No file selected")

    with open(file_path, "rb") as f_:
        resp = REQUESTS.post(
            SITE.format(page="upload"),
            files={"upload": (
                basename(file_path), fer.encrypt(f_.read())
            )},
            data={"captcha": given_code, "expect_json": "true"},
            timeout=None
        )
    if resp.status_code == 200:
        resp_json = resp.json()["data"]
        print(f"""
{Fore.GREEN}Uploaded successful: {Fore.RESET}
Share link (includes server-side password): {SITE.format(page='share/' + resp_json['file_id'] + '/' + resp_json['password'])}
Local Password: {custom_key.decode()}
""")
    else:
        error = resp.json()['error']
        if error == "captcha":
            upload_intent(file_path=file_path, custom_key=custom_key)
        else:
            print(f"upload error: {resp.json()['error']}")


upload_intent()


REQUESTS.close()
-----BEGIN PGP SIGNATURE-----

iQIzBAEBCAAdFiEEDdup6GORm839wr0TnuH2yfyrvsUFAmFrkXAACgkQnuH2yfyr
vsWm3w//ef1CA3H+Maisvrg0bP6LzAzMh8PdumjfM6DTzEN5u8lScnf5y1LICIJ1
QWY1CXVTSBSQK/bGZy+P5jXjPtTj+5g5kyb+OssH2EELQKO0q6CAclNrSw4MgimD
yzmTWGAr2iJsRNWfIcVEeBqwjAVGLtjevsOyRoejgkySI/s/RZZkVDxCbR1Kwn9M
KSnXG0emRCWfO5SL05Srx5kYgA2kdhJvcGkWmwGpkm1a7Cdz/usSYR4tUKu2sChT
uNNsFHnEnVvUsSRGybSgGxaphP5f5nhiyRO3yQC3Z23teoY51M6fpRXVMrnkaJWE
UgeFpGvNloDxD2S0Hmwly237ezLrHqOFF5c2872HoXJ7uizYpyP8Bw7Rua2tbd0V
SFDCaThyqpAPkoByVBvXUs1gUZLEk9RjpORVLbSQAQoAkFs728NVe200Hu3xLjpL
GTKAAYpRugLLNOIw1+y5YYiLewoZI3c+++CH0BE2fnm/dDQLODz4lrRT8Qwtw3OD
Ttl8f7sCj0aeO15bmxl1gczO9Ssd8ZRN0OrDfqIpTausSEexUhyvs4UaES2DI/N/
3YJYr3muAH7Ophy10Olb//4ftt/aEjwkXsh9hNmzX3UAjy+Eq81Kme2H70f/vO0e
na8dDfcwlhA+TH+be7R0fx2uwjtv0G1OOYg40I5R1FbRLZilyUw=
=2vWJ
-----END PGP SIGNATURE-----
